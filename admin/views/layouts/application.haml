- # encoding: utf-8
!!! 5
%html{:lang => 'ru'}
  %head
    %meta{:content => 'text/html; charset=utf-8', 'http-equiv' => 'Content-Type'}
    %meta{:name => :viewport, :content => 'width=device-width,initial-scale=1'}
    %title= @title.present? ? "#{@title} | Rozario Admin" : "Rozario Admin"
    =favicon_tag 'favicon.ico'
    %link{:href => '//fonts.googleapis.com/css?family=Varela', :rel => :stylesheet}
    %link{:href => '/stylesheets/admin.css', :rel => :stylesheet}
    %link{:href => "//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css", :rel => "stylesheet"}/
    %link{:href => "//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css", :rel => "stylesheet"}/
    %script{:src => "//code.jquery.com/jquery-1.12.4.js"}
    %script{:src => "//code.jquery.com/ui/1.12.1/jquery-ui.js"}


    =stylesheet_link_tag 'bootstrap', 'redactor', 'bootstrap-select.min', 'application'
    
    / Fixed overlay sidebar styles
    :css
      .admin-wrapper {
        padding-top: 60px;
        min-height: 100vh;
      }
      .admin-navbar {
        z-index: 1030;
      }
      .navbar-toggle.sidebar-toggle {
        display: block;
        float: left;
        margin-left: 15px;
        margin-right: 15px;
        padding: 9px 10px;
        background-color: transparent;
        background-image: none;
        border: 1px solid transparent;
        border-radius: 4px;
        position: relative;
        z-index: 1031;
      }
      .navbar-toggle.sidebar-toggle .icon-bar {
        display: block;
        width: 22px;
        height: 2px;
        background-color: #888;
        border-radius: 1px;
      }
      .navbar-toggle.sidebar-toggle .icon-bar + .icon-bar {
        margin-top: 4px;
      }
      .navbar-toggle.sidebar-toggle:hover .icon-bar,
      .navbar-toggle.sidebar-toggle:focus .icon-bar {
        background-color: #333;
      }
      .admin-sidebar {
        width: 280px;
        background-color: #2c3e50;
        color: #ecf0f1;
        position: fixed;
        top: 54px;
        bottom: 0;
        left: -280px;
        height: auto;
        overflow-y: auto;
        transition: left 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        z-index: 1025;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
      }
      .admin-sidebar.sidebar-open {
        left: 0;
      }
      .sidebar-header {
        padding: 20px 15px;
        border-bottom: 1px solid #34495e;
        position: relative;
      }
      .sidebar-header h4 {
        margin: 0;
        color: #ecf0f1;
        font-size: 18px;
        font-weight: 600;
      }
      .sidebar-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        color: #ecf0f1;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        text-align: center;
        line-height: 1;
        opacity: 0.7;
        transition: opacity 0.2s ease;
      }
      .sidebar-close:hover {
        opacity: 1;
      }
      .sidebar-menu {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .sidebar-item {
        border-bottom: 1px solid #34495e;
      }
      .sidebar-link {
        display: block;
        padding: 15px 20px;
        color: #bdc3c7;
        text-decoration: none;
        transition: all 0.3s ease;
      }
      .sidebar-link:hover,
      .sidebar-link:focus {
        color: #ecf0f1;
        background-color: #34495e;
        text-decoration: none;
      }
      .sidebar-item.active .sidebar-link {
        color: #ffffff;
        background-color: #3498db;
      }
      .sidebar-accordion {
        background: none;
        border: none;
        width: 100%;
        text-align: left;
        padding: 15px 20px;
        color: #bdc3c7;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }
      .sidebar-accordion:hover {
        color: #ecf0f1;
        background-color: #34495e;
      }
      .sidebar-accordion::after {
        content: '▶';
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        transition: transform 0.3s ease;
        font-size: 12px;
      }
      .sidebar-accordion.active::after {
        transform: translateY(-50%) rotate(90deg);
      }
      .sidebar-submenu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        background-color: #1a252f;
      }
      .sidebar-submenu.open {
        max-height: 500px;
      }
      .sidebar-submenu .sidebar-link {
        padding: 12px 20px 12px 40px;
        font-size: 14px;
        border-bottom: 1px solid #243242;
      }
      .sidebar-submenu .sidebar-link:hover {
        background-color: #243242;
      }
      .sidebar-submenu .sidebar-item.active .sidebar-link {
        background-color: #2980b9;
      }
      .admin-content {
        min-height: calc(100vh - 60px);
      }
      .sidebar-overlay {
        position: fixed;
        top: 54px;
        bottom: 0;
        left: 0;
        width: 100%;
        height: auto;
        background-color: rgba(0, 0, 0, 0.5);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        z-index: 1020;
      }
      .sidebar-overlay.active {
        opacity: 1;
        visibility: visible;
      }
      .sidebar-overlay.active ~ body {
        overflow: hidden;
      }
      @media (max-width: 480px) {
        .admin-sidebar {
          width: 100%;
          left: -100%;
        }
      }
    =javascript_include_tag 'jquery-1.9.0.min', 'redactor.min', 'redactor.ru', (Padrino.env == :production ? 'bootstrap/bootstrap.min' : %w[bootstrap/bootstrap-affix bootstrap/bootstrap-alert bootstrap/bootstrap-button bootstrap/bootstrap-carousel bootstrap/bootstrap-collapse bootstrap/bootstrap-dropdown bootstrap/bootstrap-tooltip bootstrap/bootstrap-transition bootstrap/bootstrap-typeahead bootstrap/bootstrap-modal bootstrap/bootstrap-popover bootstrap/bootstrap-scrollspy bootstrap/bootstrap-tab]), 'bootstrap-select.min', 'defaults-ru-RU', '/ckeditor2/ckeditor.js', :application
    = javascript_include_tag 'jquery-migrate-1.0.0.js', 'jquery-ui.js', 'chosen.order.jquery.min.js'
    =javascript_include_tag 'contacts.js'
  %script{:src => "//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"}
  %script{:src => "//unpkg.com/vue@2.5.17/dist/vue.js"}
  %script{:src => "//unpkg.com/vue-select@2.5.1/dist/vue-select.js"}
  %script{:src => "//unpkg.com/vue-multiselect@2.1.0/dist/vue-multiselect.min.js"}
  %script{:src => "//unpkg.com/clipboard@2.0.0/dist/clipboard.min.js"}
  %link{:href => "//unpkg.com/vue-multiselect@2.1.0/dist/vue-multiselect.min.css", :rel => "stylesheet"}/
  %body
    / Responsive navigation with hamburger
    %nav.navbar.navbar-fixed-top.admin-navbar
      .navbar-inner
        .container-fluid
          / Hamburger button for mobile devices
          %button.navbar-toggle.sidebar-toggle{:type => "button"}
            %span.sr-only Toggle navigation
            %span.icon-bar
            %span.icon-bar
            %span.icon-bar
          
          =link_to 'Rozario', url(:base_index), :class => 'navbar-brand', :title => 'Rozario Admin'
          
          - if current_account
            %ul.nav.navbar-nav.pull-right
              %li.navbar-edit-account=link_to tag_icon(:user), url(:accounts, :edit, :id => current_account.id), :title => pat(:profile), :class => 'navbar-nav-link'
              %li.navbar-logout
                =button_to :logout, url(:sessions, :destroy), :method => :delete, :class => 'navbar-nav-form' do
                  =content_tag :button, tag_icon(:off), :type => :submit, :title => pat(:logout), :class => 'navbar-nav-form-link'

    / Overlay for blocking interface when sidebar is open
    .sidebar-overlay
    
    / Fixed sidebar
    .admin-sidebar
      .sidebar-header
        %h4 Navigation
        %button.sidebar-close{:type => "button", :title => "Закрыть меню"}
          %span &times;
      
      %ul.sidebar-menu
        %li.sidebar-item
          %button.sidebar-accordion{:type => "button"} Manage
          %ul.sidebar-submenu
            - menu_entries.each do |project_module|
              %li{:class => "sidebar-item #{('active' if request.path_info =~ /^#{project_module.path}/)}"}
                =link_to I18n.t("padrino.admin.menu.#{project_module.name}"), project_module.path('/admin'), :class => 'sidebar-link'
            %li{:class => "sidebar-item #{'active' if request.path_info =~ /tags/}"}
              =link_to "Теги", '/admin/tags', :class => 'sidebar-link'
            %li{:class => "sidebar-item #{'active' if request.path_info =~ /slides/}"}
              =link_to "Слайды", '/admin/slides', :class => 'sidebar-link'
            %li{:class => "sidebar-item #{'active' if request.path_info =~ /payment/}"}
              =link_to "Способы оплаты", '/admin/payment_methods', :class => 'sidebar-link'
            %li{:class => "sidebar-item #{'active' if request.path_info =~ /seo/}"}
              =link_to "SEO", '/admin/seo', :class => 'sidebar-link'
            %li{:class => "sidebar-item #{'active' if request.path_info =~ /comments/}"}
              =link_to "Комментарии", '/admin/comments', :class => 'sidebar-link'
            %li{:class => "sidebar-item #{'active' if request.path_info =~ /smiles/}"}
              =link_to "Отзывы", '/admin/smiles', :class => 'sidebar-link'
        
        %li.sidebar-item
          %button.sidebar-accordion{:type => "button"} Testing
          %ul.sidebar-submenu
            %li.sidebar-item
              =link_to "Test Suite", '#', :class => 'sidebar-link'
            %li.sidebar-item
              =link_to "Debug Panel", '#', :class => 'sidebar-link'
    
    / Main content wrapper
    .admin-wrapper
      .admin-content
        .container-fluid.main
          .main-wrapper
            =[:error, :warning, :success, :notice].map { |type| flash_tag(type, :class => "alert alert-#{type} fade in", :bootstrap => true) }.join.html_safe
            =yield
            .main-wrapper-push

    %footer
      .footer-wrapper.container
        %p.pull-left
          Copyright &copy;
          =Time.now.year
          Rozario — Powered by Padrino v.#{Padrino.version} and
          =link_to 'kereal.ru', 'http://kereal.ru', :target => :_blank, :class => 'footer-links-link', :title => 'kereal.ru'
        %ul.pull-right.footer-links
          %li= link_to tag_icon(:heart, 'whiteplus'), 'http://whiteplus.ru', :target => :_blank, :class => 'footer-links-link', :title => 'Белый плюс любит вас :)'
          /%li= link_to tag_icon(:home, 'web'), 'http://www.padrinorb.com', :target => :_blank, :class => 'footer-links-link'
          /%li= link_to tag_icon(:heart, 'blog'), 'http://www.padrinorb.com/blog', :target => :_blank, :class => 'footer-links-link'
          /%li= link_to tag_icon(:github, 'code'), 'https://github.com/padrino/padrino-framework', :target => :_blank, :class => 'footer-links-link'
          /%li= link_to tag_icon(:twitter, 'twitter'), 'http://twitter.com/padrinorb', :target => :_blank, :class => 'footer-links-link'
    :javascript
      var btns = document.querySelectorAll('.copy-tag');
      var clipboard = new ClipboardJS(btns);
      
      // Admin sidebar management
      (function() {
        var sidebar = document.querySelector('.admin-sidebar');
        var overlay = document.querySelector('.sidebar-overlay');
        var toggleBtn = document.querySelector('.sidebar-toggle');
        var closeBtn = document.querySelector('.sidebar-close');
        
        if (!sidebar || !overlay || !toggleBtn) {
          console.log('Sidebar elements not found');
          return;
        }
        
        function openSidebar() {
          sidebar.classList.add('sidebar-open');
          overlay.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
        
        function closeSidebar() {
          sidebar.classList.remove('sidebar-open');
          overlay.classList.remove('active');
          document.body.style.overflow = '';
        }
        
        function toggleSidebar() {
          if (sidebar.classList.contains('sidebar-open')) {
            closeSidebar();
          } else {
            openSidebar();
          }
        }
        
        toggleBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          toggleSidebar();
        });
        
        if (closeBtn) {
          closeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeSidebar();
          });
        }
        
        overlay.addEventListener('click', function() {
          closeSidebar();
        });
        
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && sidebar.classList.contains('sidebar-open')) {
            closeSidebar();
          }
        });
        
        // Auto-close sidebar on window resize
        window.addEventListener('resize', function() {
          closeSidebar();
        });
        
        // Close sidebar when clicking on menu links
        var sidebarLinks = document.querySelectorAll('.sidebar-link');
        sidebarLinks.forEach(function(link) {
          link.addEventListener('click', function() {
            setTimeout(function() {
              closeSidebar();
            }, 150);
          });
        });
        
        // Accordion functionality
        var accordionButtons = document.querySelectorAll('.sidebar-accordion');
        accordionButtons.forEach(function(button) {
          button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            var submenu = this.nextElementSibling;
            var isActive = this.classList.contains('active');
            
            // Close all other accordions
            accordionButtons.forEach(function(otherButton) {
              if (otherButton !== button) {
                otherButton.classList.remove('active');
                var otherSubmenu = otherButton.nextElementSibling;
                if (otherSubmenu) {
                  otherSubmenu.classList.remove('open');
                }
              }
            });
            
            // Toggle current accordion
            if (isActive) {
              this.classList.remove('active');
              if (submenu) {
                submenu.classList.remove('open');
              }
            } else {
              this.classList.add('active');
              if (submenu) {
                submenu.classList.add('open');
              }
            }
          });
        });
        
        // Auto-open accordion if current page is inside
        var activeSubmenuItems = document.querySelectorAll('.sidebar-submenu .sidebar-item.active');
        if (activeSubmenuItems.length > 0) {
          var parentAccordion = activeSubmenuItems[0].closest('.sidebar-item').querySelector('.sidebar-accordion');
          var parentSubmenu = activeSubmenuItems[0].closest('.sidebar-submenu');
          if (parentAccordion && parentSubmenu) {
            parentAccordion.classList.add('active');
            parentSubmenu.classList.add('open');
          }
        }
        
        console.log('Admin sidebar initialized');
      })();
